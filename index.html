<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BR Wahl – Liste FVK & Friends</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>

  <style>
   html, body {
  margin: 0;
  padding: 0;
  height: 100%;
}

body {
  background-image: url("assets/background.jpg");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  background-attachment: fixed;

  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
}

/* Overlay für bessere Lesbarkeit */
body::before {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(255, 255, 255, 0.35); /* Stärke anpassbar */
  z-index: -1;

  /* ===== THEME: Background sichtbar + Lesbarkeit ===== */

/* Textfarbe global hell setzen */
body {
  color: #fff;
}

/* Falls irgendwo Standard-Links */
a { color: #fff; }

/* Slides/Container NICHT schwarz hinterlegen */
.slide,
.content,
#overview,
#slideshow,
.swiper,
.swiper-slide {
  background: transparent !important;
}

/* Textbereich als "Glass"-Card (damit Text lesbar bleibt) */
.content {
  background: rgba(0, 0, 0, 0.45) !important;  /* halbtransparent */
  backdrop-filter: blur(8px);
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,0.15);
}

/* Buttons in der Übersicht ebenfalls als Glass */
.btn {
  background: rgba(0, 0, 0, 0.40) !important;
  border: 1px solid rgba(255,255,255,0.18) !important;
}

/* Name + Text im Textbereich */
.name { color: #fff; }
.text { color: rgba(255,255,255,0.92); }

/* Bildbereich: kein schwarzer Kasten */
.photoWrap {
  background: transparent !important;
}

/* Bild selbst: keine extra Fläche */
.photoWrap img {
  background: transparent !important;
}

/* Statusbar unten: statt Vollschwarz halbtransparent */
.statusbar {
  background: rgba(0,0,0,0.55) !important;
  backdrop-filter: blur(8px);
  border-top: 1px solid rgba(255,255,255,0.15) !important;
}

    /* Übersicht */
    #overview{padding:16px}
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(150px,1fr));
      gap:10px;
    }
    .btn{
      background:#1c1c1f;
      border:1px solid #2a2a2e;
      color:#fff;
      padding:12px;
      border-radius:10px;
      font-size:14px;
      text-align:center;
    }

    /* Slideshow */
    #slideshow{display:none; position:relative}
    .swiper{height:calc(100vh - 52px - 30px);} /* Header + Statusbar */
    .back{
      position:absolute;
      top:10px;
      left:10px;
      z-index:10;
      background:rgba(0,0,0,.6);
      border:1px solid #333;
      color:#fff;
      padding:6px 10px;
      border-radius:8px;
      font-size:13px;
    }

    /* Slide Layout: Bild oben, Text unten */
    .slide{
      height:100%;
      display:flex;
      flex-direction:column;
      background:#0b0b0c;
    }
    .photoWrap{
      flex: 0 0 40%;
      min-height: 35%;
      background:#111;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .photoWrap img{
      width:100%;
      height:100%;
      object-fit:contain; /* GANZES BILD, kein Abschneiden */
      background:#111;
      display:block;
    }
    .content{
      flex:1 1 auto;
      min-height:0;
      padding:14px 16px 18px;
      border-top:1px solid #222;
      overflow:auto; /* scrollbarer Text */
      background:#0b0b0c;
    }
    .name{font-size:22px;font-weight:700;margin:0 0 10px}
    .text{font-size:15px;line-height:1.45;margin:0;opacity:.95;white-space:pre-wrap}

    /* Statusbar */
    .statusbar{
      position:fixed;
      left:0; right:0; bottom:0;
      background:#0b0b0c;
      border-top:1px solid #222;
      padding:6px 12px;
      font-size:12px;
      opacity:.9;
      display:flex;
      gap:12px;
      justify-content:center;
      z-index:20;
      flex-wrap:wrap;
    }
    .statusbar span{white-space:nowrap}

    /* Fehlerkarte */
    .errorCard{
      padding:18px;
      border:1px solid #2a2a2e;
      background:#141417;
      border-radius:12px;
      margin:16px;
    }
    .errorTitle{font-weight:700;margin:0 0 8px;font-size:18px}
    .errorText{margin:0;opacity:.9;line-height:1.35}
    code{background:#0f0f12;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>

<header class="wrap"><h1>BR Wahl – Liste FVK & Friends</h1></header>

<div class="wrap">

  <!-- Übersicht -->
  <section id="overview">
    <div class="grid" id="buttons"></div>
    <div id="overviewError"></div>
  </section>

  <!-- Slideshow -->
  <section id="slideshow">
    <button class="back" onclick="showOverview()">Übersicht</button>
    <div class="swiper">
      <div class="swiper-wrapper" id="slides"></div>
      <div class="swiper-pagination"></div>
    </div>
  </section>

</div>

<!-- Statusbar -->
<div class="statusbar">
  <span id="statusCandidates">Kandidaten: 0</span>
  <span id="statusImagesOk">Bilder OK: 0</span>
  <span id="statusImagesErr">Fehler: 0</span>
  <span id="statusMsg">Status: Start…</span>
</div>

<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script>
let swiper = null;
let candidates = [];
let imagesOk = 0;
let imagesErr = 0;

function setText(id, txt){ document.getElementById(id).textContent = txt; }
function setStatus(msg){ setText('statusMsg', 'Status: ' + msg); }

function showError(whereId, title, msg){
  const el = document.getElementById(whereId);
  el.innerHTML = `
    <div class="errorCard">
      <p class="errorTitle">${title}</p>
      <p class="errorText">${msg}</p>
    </div>`;
}

function resetCounts(){
  imagesOk = 0; imagesErr = 0;
  setText('statusImagesOk', 'Bilder OK: 0');
  setText('statusImagesErr', 'Fehler: 0');
}

window.__imgOk = function(){ imagesOk++; setText('statusImagesOk', 'Bilder OK: ' + imagesOk); };
window.__imgErr = function(){ imagesErr++; setText('statusImagesErr', 'Fehler: ' + imagesErr); };

async function loadCandidates(){
  setStatus('Lade candidates.json…');

  const res = await fetch('/candidates.json', { credentials:'include', cache:'no-store' });
  const body = await res.text();

  // Falls Middleware/Session nicht greift und HTML zurückkommt:
  if (body.trim().startsWith('<')) {
    throw new Error('candidates.json kam als HTML zurück (Login/Cookie). Öffne die Seite erneut mit ?pw=… oder nutze Inkognito.');
  }

  let data;
  try {
    data = JSON.parse(body);
  } catch (e) {
    throw new Error('candidates.json ist kein gültiges JSON: ' + e.message);
  }

  if (!Array.isArray(data)) throw new Error('candidates.json muss ein Array sein.');
  return data;
}

function normalizeCandidate(c){
  // Defensive: falls Felder fehlen, nicht alles zerlegen
  return {
    fullName: c.fullName ?? '',
    firstName: c.firstName ?? '',
    lastName: c.lastName ?? '',
    photo: c.photo ?? '',
    text: c.text ?? ''
  };
}

function renderOverview(){
  const btns = document.getElementById('buttons');
  btns.innerHTML = candidates.map((c,i)=>`
    <button class="btn" onclick="openSlide(${i})">
      ${escapeHtml(c.lastName)}, ${escapeHtml(c.firstName)}
    </button>
  `).join('');
}

function renderSlides(){
  resetCounts();
  const slides = document.getElementById('slides');
  slides.innerHTML = candidates.map((c)=>`
    <div class="swiper-slide">
      <div class="slide">
        <div class="photoWrap">
          <img
            src="/${c.photo}"
            alt="${escapeAttr(c.fullName)}"
            loading="eager"
            onload="window.__imgOk()"
            onerror="window.__imgErr()"
          >
        </div>
        <div class="content">
          <p class="name">${escapeHtml(c.fullName)}</p>
          <p class="text">${escapeHtml(c.text)}</p>
        </div>
      </div>
    </div>
  `).join('');

  if (swiper) swiper.destroy(true, true);
  swiper = new Swiper('.swiper', {
    loop: true,
    pagination: { el: '.swiper-pagination' }
  });
}

function openSlide(index){
  document.getElementById('overview').style.display='none';
  document.getElementById('slideshow').style.display='block';
  swiper.slideToLoop(index, 0);
}

function showOverview(){
  document.getElementById('slideshow').style.display='none';
  document.getElementById('overview').style.display='block';
}

/* Helpers um HTML-Injection zu vermeiden */
function escapeHtml(str){
  return String(str)
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#39;");
}
function escapeAttr(str){ return escapeHtml(str); }

async function init(){
  try {
    const data = await loadCandidates();
    candidates = data.map(normalizeCandidate);

    setText('statusCandidates', 'Kandidaten: ' + candidates.length);
    setStatus('OK – Daten geladen');

    renderOverview();
    renderSlides();
  } catch (e) {
    setText('statusCandidates', 'Kandidaten: 0');
    setText('statusImagesOk', 'Bilder OK: 0');
    setText('statusImagesErr', 'Fehler: 0');
    setStatus('Fehler');

    showError(
      'overviewError',
      'Fehler beim Laden',
      `${escapeHtml(e.message)}<br><br>Teste: <code>/candidates.json?pw=TEST123</code>`
    );
  }
}

init();
</script>
</body>
</html>
